# Web Workflow

name: Web in AKS

on: [push]

jobs:
  buildpush:
    runs-on: ubuntu-16.04
    steps:
    - uses: actions/checkout@v1
    # Connect to Azure Container registry (ACR)
    - uses: azure/docker-login@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }} 
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: Docker build and push
      working-directory: Source/Tailwind.Traders.Web
      run: | 
        # docker build . --build-arg sdkTag=2.1 --build-arg runtimeTag=2.1 -t tailwindtraders/web:gh-${{ github.sha }} -t latest
        # docker push tailwindtraders/web:gh-${{ github.sha }}
        docker build . --build-arg sdkTag=2.1 --build-arg runtimeTag=2.1 -t ivilches/tests:gh-${{ github.sha }} -t latest
        docker push ivilches/tests:gh-${{ github.sha }}

    - uses: azure/login@v1
      with:
        creds: '${{ secrets.AZURE_CREDENTIALS }}'

    - name: Set AKS kubectl context
      uses: azure/aks-set-context@master
      with:
        creds: '${{ secrets.AZURE_CREDENTIALS }}'
        cluster-name: ${{ secrets.CLUSTER_NAME }}
        resource-group: ${{ secrets.RESOURCE_GROUP }}        
    - name: Init Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 > get_helm.sh
        chmod 700 get_helm.sh
        ./get_helm.sh
        # az acr helm repo add -n ${{ secrets.ACR_NAME }}
    # - name: Package Helm chart
    #   run: |
    #     helm package  Deploy/helm/web -d Deploy/helm/__charts --version 1.0.0-${{ github.sha }}
    # - name: Upload chart to ACR
    #   run: |
    #     az acr helm push Deploy/helm/__charts/web-1.0.0-${{ github.sha }}.tgz -n ${{ secrets.ACR_NAME }}
    # - name: Generate config file
    #   shell: pwsh
    #   run: |
    #     az extension add --name application-insights
    #     Deploy/powershell/Generate-Config.ps1 -gvaluesTemplate gvalues.template.gh -resourceGroup ${{ secrets.RESOURCE_GROUP }} -outputFile _values-gh.yaml -twitterKey ${{ secrets.TWITTER_KEY }} -twitterSecret ${{ secrets.TWITTER_SECRET }} -sslSupport custom -aksHost ${{ secrets.AKS_HOST }} -googleanalytics ${{ secrets.GOOGLE_ANALYTICS }} -configScale y -resourceGroupAcr ${{ secrets.RESOURCE_GROUP_ACR }}
    - name: Install Helm Chart
      shell: pwsh
      run: |
        helm repo update
        # helm upgrade --install web -f Deploy/helm/gvalues.yaml -f Deploy/helm/values.b2c.yaml --set inf.appinsights.id="" --set az.productvisitsurl="" --set ingress.hosts={$aksHost} --set image.repository=ivilches/tailwindtraders --set image.tag=${{ github.sha }}
        # helm upgrade --install -f Deploy/powershell/_values-gh.yaml --set image.repository=${{ secrets.ACR_NAME }}.azurecr.io/web --set image.tag=gh-${{ github.sha }} --set image.uploaderRepository=${{ secrets.ACR_NAME }}.azurecr.io/modeluploader --set image.uploaderTag=gh-${{ github.sha }} --set uploaderEnabled=false --set scaleWeb=true --set replicaCount=2 web  ${{ secrets.ACR_NAME }}/web --version=1.0.0-${{ github.sha }}
        Deploy\DeployWebAKS.ps1 -name web -aksName ${{ secrets.CLUSTER_NAME }} -resourceGroup ${{ secrets.RESOURCE_GROUP }} -tag gh-${{ github.sha }}


